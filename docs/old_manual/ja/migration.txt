Doctrineのマイグレーションツールによってデータベースを移動させてデータベースの変更をデプロイしたい場合テーブル変更の命令文を直接データベースに発行できるようになります。

++ マイグレーションクラスを書く

マイグレーションクラスはDoctrine_Migrationを拡張するシンプルなクラスで構成されます。そのマイグレーションステップに対してデータベースに変更と取り消しを行うために作られたpublicなup()とdown()メソッドを定義できます。クラス名は完全に任意ですが、クラスを含むファイルの名前はマイグレーションプロセスを表す番号を含む接頭辞を含まなければなりません。例: XXX_representative_name.class.php

<code type="php">
// 001_add_table.class.php
class AddTable extends Doctrine_Migration
{
    public function up()
    {
        $this->createTable('migration_test', array('field1' => array('type' => 'string')));
    }
    
    public function down()
    {
        $this->dropTable('migration_test');
    }
}

// 002_add_column.class.php
class AddColumn extends Doctrine_Migration
{
    public function up()
    {
        $this->addColumn('migration_test', 'field1', 'string');
    }
    
    public function down()
    {
        $this->renameColumn('migration_test', 'field1', 'field2');
    }
}

// 003_change_column.class.php
class ChangeColumn extends Doctrine_Migration
{
    public function up()
    {
        $this->changeColumn('migration_test', 'field1', 'integer');
    }
    
    public function down()
    {
        $this->changeColumn('migration_test', 'field1', 'string');
    }  
}
</code>

+++ メソッド

マイグレーションクラスでデータベースを変更するために利用できるメソッドの一覧は次の通りです

<code type="php">
public function createTable($tableName, array $fields = array(), array $options = array())
public function dropTable($tableName)
public function renameTable($oldTableName, $newTableName)
public function addColumn($tableName, $columnName, $type, array $options = array())
public function renameColumn($tableName, $oldColumnName, $newColumnName)
public function changeColumn($tableName, $columnName, $type, array $options = array())
public function removeColumn($tableName, $columnName)
public function addIndex($tableName, $indexName, array $options = array())
public function removeIndex($tableName, $indexName)
</code>

+++ データを変える

通常のように新しいモデルインスタンスを作成してsave()を呼び出すもしくはクエリーを作成してデータを削除するようにup()とdown()メソッドで直接テーブルを変更できます。

<code type="php">
// XXX_add_user.class.php
class AddUser extends Doctrine_Migration
{
    public function up()
    {
        // 新しいユーザーを追加する
        $user = new User();
        $user->loginname = 'jwage';
        $user->save();
    }
    
    public function down()
    {
        // 上で追加したユーザーを削除する
        $query = new Doctrine_Query();
        $query->delete('User')->from('User u')->where('u.loginname = ?', 'jwage')->execute();
        
    }
}
</code>

++ マイグレーションを実行する

<code type="php">
$migration = new Doctrine_Migration('/path/to/migration_classes');

// 現在のバージョンは0とする
$migration->migrate(3); // 0から3にする
$migration->migrate(0); // 3から0にする

echo $migration->getCurrentVersion(); // 0
</code>